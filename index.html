<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SMS Receiver</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: dark light; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; background:#0f1115; color:#e6e7ea; }
    header { padding:16px 20px; font-size:22px; font-weight:700; background:#12141a; border-bottom:1px solid #22252e; }
    main { max-width: 900px; margin: 0 auto; padding: 16px; }
    .card { background:#141823; border:1px solid #232835; border-radius:14px; padding:14px 16px; margin:12px 0; display:grid; grid-template-columns: 1fr auto; gap:10px; }
    .meta { font-size:13px; opacity:.85; }
    .row { margin:2px 0; }
    .text { grid-column: 1 / -1; white-space: pre-wrap; word-break: break-word; font-size:15px; }
    .btn-del { align-self:start; padding:8px 10px; border-radius:10px; border:1px solid #3a4254; background:#1b2130; color:#f3f4f6; cursor:pointer; }
    .btn-del:hover { background:#222a3d; }
    .empty { opacity:.7; text-align:center; padding:40px 0; }
    .to-number { font-weight:700; }
  </style>
</head>
<body>
  <header>SMS Receiver</header>
  <main>
    <div id="list" class="list"></div>
    <div id="empty" class="empty" style="display:none">No messages yet.</div>
  </main>

  <!-- Socket.IO client served by your Node server -->
  <script src="/socket.io/socket.io.js"></script>

  <script>
    const listEl = document.getElementById('list');
    const emptyEl = document.getElementById('empty');

    // Escape helper
    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // ===== Stable color for same number/operator =====
    function hashString(str) {
      let h = 2166136261; // FNV-1a base
      for (let i = 0; i < str.length; i++) {
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return h >>> 0;
    }
    function stableColorFromString(str) {
      const s = String(str || '').trim();
      const base = s || 'unknown';
      const hue = hashString(base) % 360;
      return `hsl(${hue} 85% 65%)`;
    }
    // ===============================================

    function setEmpty(hasMsg) {
      emptyEl.style.display = hasMsg ? 'none' : 'block';
    }

    function renderLatest(latest) {
      // লেটেস্ট সবসময় উপরে—এখানে যেহেতু "সর্বশেষ SMS" দেখাচ্ছি, তাই একটাই কার্ড রাখছি
      const toVal = latest.to || '';
      const toColor = stableColorFromString(toVal);

      listEl.innerHTML = `
        <div class="card" id="latest-card">
          <div>
            <div class="meta row"><strong>time:</strong> ${escapeHtml(latest.timestamp || '')}</div>
            <div class="meta row"><strong>to:</strong> <span class="to-number" style="color:${toColor}">${escapeHtml(toVal)}</span></div>
            <div class="text"><strong>text:</strong> ${escapeHtml(latest.message || '')}</div>
          </div>
          <div>
            <button class="btn-del" id="btnDel" title="Delete this message">Delete</button>
          </div>
        </div>
      `;

      document.getElementById('btnDel').addEventListener('click', async () => {
        try {
          // DELETE ব্লক হলে POST fallback ব্যবহার করবেন
          await fetch('/sms', { method: 'DELETE' });
        } catch (err) {
          console.error(err);
          try { await fetch('/sms/delete', { method: 'POST' }); } catch(e) {}
        }
      });

      setEmpty(true);
    }

    function clearUI(reason) {
      listEl.innerHTML = '';
      setEmpty(false);
      console.log('Cleared:', reason);
    }

    // Connect Socket.IO
    const socket = io();

    socket.on('connect', () => {
      console.log('Socket connected:', socket.id);
    });

    socket.on('newMessage', (latest) => {
      renderLatest(latest);
    });

    socket.on('messageDeleted', (info) => {
      clearUI(info?.reason || 'deleted');
    });
  </script>
</body>
</html>
