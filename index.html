<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SMS Receiver</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: dark light; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; background:#0f1115; color:#e6e7ea; }
    header { padding:16px 20px; font-size:22px; font-weight:700; background:#12141a; border-bottom:1px solid #22252e; }
    main { max-width: 900px; margin: 0 auto; padding: 16px; }
    .card { background:#141823; border:1px solid #232835; border-radius:14px; padding:14px 16px; margin:12px 0; display:grid; grid-template-columns: 1fr auto; gap:10px; }
    .meta { font-size:13px; opacity:.85; }
    .row { margin:2px 0; }
    .text { grid-column: 1 / -1; white-space: pre-wrap; word-break: break-word; font-size:15px; }
    .btn-del { align-self:start; padding:8px 10px; border-radius:10px; border:1px solid #3a4254; background:#1b2130; color:#f3f4f6; cursor:pointer; }
    .btn-del:hover { background:#222a3d; }
    .empty { opacity:.7; text-align:center; padding:40px 0; }
    a { color:#bcd3ff; text-decoration:none; }

    /* মোবাইল নম্বর হাইলাইট (শেষ ৩ ডিজিট রঙিন হবে) */
    .to-number { font-weight:700; color: inherit; }
    .to-suffix { font-weight:800; }
  </style>
</head>
<body>
  <header>SMS Receiver</header>
  <main>
    <div id="list" class="list"></div>
    <div id="empty" class="empty" style="display:none">No messages yet.</div>
  </main>

  <script>
    const listEl = document.getElementById('list');
    const emptyEl = document.getElementById('empty');

    const state = new Map(); // id -> record

    function setEmpty() {
      emptyEl.style.display = state.size ? 'none' : 'block';
    }

    // Escape helper
    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // ---------- ✅ Color + phone highlight helpers ----------
    function hash32(str) {
      // FNV-1a 32-bit
      let h = 2166136261;
      for (let i = 0; i < str.length; i++) {
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      return h >>> 0;
    }

    function colorFromSeed(seed) {
      const h = hash32(seed);
      const hue = h % 360;
      const sat = 70 + ((h >>> 8) % 25);    // 70-94
      const light = 55 + ((h >>> 16) % 15); // 55-69
      return `hsl(${hue}, ${sat}%, ${light}%)`;
    }

    function ensureUi(rec) {
      if (!rec) return;
      if (!rec.ui) rec.ui = {};
      if (!rec.ui.toColor) {
        const seed =
          String(rec.id ?? '') + '|' +
          String(rec?.parts?.to ?? '') + '|' +
          String(rec?.parts?.time ?? '');
        // seed না থাকলে fallback
        rec.ui.toColor = colorFromSeed(seed || String(Math.random()));
      }
    }

    function highlightLast3DigitsHtml(input, color) {
      const str = String(input ?? '');

      // শেষ ৩টা digit কোন কোন index এ আছে সেটা mark করি
      const mark = new Array(str.length).fill(false);
      let need = 3;
      for (let i = str.length - 1; i >= 0 && need > 0; i--) {
        if (/\d/.test(str[i])) {
          mark[i] = true;
          need--;
        }
      }

      // ৩টা digit না থাকলে—যেমন আছে তেমনই দেখাই
      if (need > 0) return escapeHtml(str);

      // marked অংশগুলো span দিয়ে wrap (safe escaping সহ)
      let out = '';
      let i = 0;
      while (i < str.length) {
        if (!mark[i]) {
          let j = i;
          while (j < str.length && !mark[j]) j++;
          out += escapeHtml(str.slice(i, j));
          i = j;
        } else {
          let j = i;
          while (j < str.length && mark[j]) j++;
          out += `<span class="to-suffix" style="color:${color}">${escapeHtml(str.slice(i, j))}</span>`;
          i = j;
        }
      }
      return out;
    }

    function toNumberHtml(rec) {
      ensureUi(rec);
      const to = rec?.parts?.to ?? '';
      return highlightLast3DigitsHtml(to, rec.ui.toColor);
    }
    // ------------------------------------------------------

    function cardTpl(rec) {
      ensureUi(rec);

      const wrap = document.createElement('div');
      wrap.className = 'card';
      wrap.id = `msg-${rec.id}`;
      wrap.innerHTML = `
        <div>
          <div class="meta row"><strong>time:</strong> ${escapeHtml(rec.parts.time || '')}</div>
          <div class="meta row"><strong>to:</strong> <span class="to-number">${toNumberHtml(rec)}</span></div>
          <div class="text"><strong>text:</strong> ${escapeHtml(rec.parts.text || '')}</div>
        </div>
        <div>
          <button class="btn-del" data-id="${rec.id}" title="Delete this message">Delete</button>
        </div>
      `;
      wrap.querySelector('.btn-del').addEventListener('click', async (e) => {
        const id = e.currentTarget.getAttribute('data-id');
        try { await fetch(`/api/messages/${id}`, { method: 'DELETE' }); }
        catch (err) { console.error(err); }
      });
      return wrap;
    }

    // ✅ নতুন কার্ড সবসময় তালিকার শুরুর দিকে বসানো হবে (top)
    // + যদি একই id আবার আসে, আগেরটা সরিয়ে একেবারে উপরে বসবে (order যেন কখনো নষ্ট না হয়)
    function addTop(rec) {
      ensureUi(rec);
      state.set(rec.id, rec);

      const existing = document.getElementById(`msg-${rec.id}`);
      if (existing) existing.remove();

      const el = cardTpl(rec);
      if (listEl.firstChild) listEl.insertBefore(el, listEl.firstChild);
      else listEl.appendChild(el);

      setEmpty();
    }

    function removeCard(id) {
      state.delete(id);
      const el = document.getElementById(`msg-${id}`);
      if (el) el.remove();
      setEmpty();
    }

    // ✅ batch render: লেটেস্ট সবসময় উপরে (time/id দেখে sort)
    function recSortKey(rec) {
      const t = rec?.parts?.time ?? rec?.time ?? rec?.timestamp ?? '';
      const ms = Date.parse(t);
      if (Number.isFinite(ms)) return ms;

      // fallback: numeric time string
      const n = Number(t);
      if (Number.isFinite(n)) return n;

      // fallback: numeric id
      const idn = Number(rec?.id);
      if (Number.isFinite(idn)) return idn;

      return 0;
    }

    function renderBatchLatestFirst(arr) {
      listEl.innerHTML = '';
      state.clear();

      const sorted = (arr || []).slice().sort((a, b) => {
        const kb = recSortKey(b);
        const ka = recSortKey(a);
        if (kb !== ka) return kb - ka;  // latest first
        // tie-breaker: id desc (best-effort)
        const ib = String(b?.id ?? '');
        const ia = String(a?.id ?? '');
        return ib.localeCompare(ia);
      });

      for (const rec of sorted) {
        ensureUi(rec);
        state.set(rec.id, rec);
        listEl.appendChild(cardTpl(rec)); // already latest->oldest
      }
      setEmpty();
    }

    // Initial load
    async function bootFetch() {
      try {
        const arr = await (await fetch('/api/messages')).json();
        renderBatchLatestFirst(arr);
      } catch (e) { console.warn('init fetch failed', e); }
    }

    // Live SSE
    function bootSSE() {
      const es = new EventSource('/events');
      es.onmessage = (ev) => {
        try {
          const payload = JSON.parse(ev.data);
          if (payload.type === 'init') {
            renderBatchLatestFirst(payload.data);
          } else if (payload.type === 'new') {
            addTop(payload.data); // নতুন এলেই একেবারে উপরে
          } else if (payload.type === 'delete') {
            removeCard(payload.id);
          }
        } catch {}
      };
      es.onerror = () => console.warn('SSE disconnected…');
    }

    bootFetch();
    bootSSE();
  </script>
</body>
</html>
